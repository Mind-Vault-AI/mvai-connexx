name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - claude/mvai-connexx-multi-tenant-upgrade-8eDvw
      - main

env:
  PROJECT_ID: mindvault-ai-com
  SERVICE_NAME: mvai-connexx
  REGION: europe-west1

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has-secret: ${{ steps.check.outputs.has-secret }}
    steps:
      - name: Check if GCP_SA_KEY secret exists
        id: check
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "has-secret=false" >> $GITHUB_OUTPUT
            echo "::warning::GCP_SA_KEY secret is not set. Deployment will be skipped."
            echo "::warning::To enable automatic deployments, please configure the GCP_SA_KEY secret."
            echo "::warning::See AUTODEPLOY_SETUP.md for instructions."
          else
            echo "has-secret=true" >> $GITHUB_OUTPUT
            echo "‚úÖ GCP_SA_KEY secret is configured"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.has-secret == 'true'
    permissions:
      contents: read

    steps:
  with:
    workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
    service_account: 'my-service-account@my-project.iam.gserviceaccount.com'

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source . \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --set-env-vars=PAYMENT_PROVIDER=gumroad,FLASK_DEBUG=false \
            --project=${{ env.PROJECT_ID }}

      - name: Get Service URL
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)' \
            --project=${{ env.PROJECT_ID }})
          echo "üöÄ DEPLOYED TO: $URL"

  deployment-skipped:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.has-secret == 'false'
    permissions:
      contents: read
    steps:
      - name: Deployment skipped notice
        run: |
          echo "‚è≠Ô∏è Deployment skipped - GCP_SA_KEY secret is not configured"
          echo ""
          echo "üìñ To enable automatic deployments to Google Cloud Run:"
          echo "   1. Create a GCP service account with Cloud Run permissions"
          echo "   2. Download the JSON key file"
          echo "   3. Add it as a repository secret named 'GCP_SA_KEY'"
          echo ""
          echo "üìö See AUTODEPLOY_SETUP.md for detailed instructions"
          echo ""
          echo "üîó Configure secrets at:"
          echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
